function IndexedDBWrapper(g,p){var k=this,h,e={version:1,skipKeys:!1,debug:0},l=function(a,b){console.log("IDB:DEBUG:"+a+": "+b)},m=function(a,b){console.error("IDB:"+a+": "+b);"function"==typeof k.OnError&&k.OnError(a,b)};this.IsAvailable=function(){return"undefined"!=typeof indexedDB?!0:!1};this.OnUpgrade=function(){1<e.debug&&l("ONUPGRADE","Upgrade action goes here")};this.OnError=function(a,b){};this.CREATE=function(a,b,c){var d={},d="object"!=typeof a?{name:a,primaryKey:b,indicies:c}:a;if(!d.hasOwnProperty("name"))throw"Table object has no table name defined";
if(!d.hasOwnProperty("primaryKey"))throw"Table object must contain a primary key";a=d;h.objectStoreNames.contains(a.name)&&h.deleteObjectStore(a.name);1<e.debug&&l("CREATESTORE","Creating table "+a.name+" with keyPath "+a.primaryKey+"(skipKeys:"+e.skipKeys+")");b=e.skipKeys?h.createObjectStore(a.name):h.createObjectStore(a.name,{keyPath:a.primaryKey});if(void 0!=a.indicies&&0<a.indicies.length)for(c=0;c<a.indicies.length;++c)b.createIndex("ix"+a.indicies[c],a.indicies[c]),1<e.debug&&l("CREATESTORE",
"...with index '"+a.indicies[c]+"'")};this.DESTROY=function(a){h.deleteObjectStore(a)};this.open=function(a){if(k.IsAvailable()){var b=indexedDB.open(g,e.version);b.onupgradeneeded=function(a){0<e.debug&&l("OPEN","Upgrading database '"+g+"'");h=a.target.result;a.target.transaction.onerror=function(){m("UPGRADE","Error in "+g+": "+b.error.message)};"function"==typeof k.OnUpgrade&&k.OnUpgrade(h,a.oldVersion,a.newVersion)};b.onsuccess=function(b){0<e.debug&&l("OPEN","IndexedDB successfully initialized "+
b.target.result);h=b.target.result;"function"==typeof a&&a()};b.onerror=function(){m("OPEN","Failed to open DB "+g+": "+b.error.message)}}};this.INSERT=function(a,b,c){if(k.IsAvailable()){var d=h.transaction([a],"readwrite");d.oncomplete=function(a){"function"==typeof c&&c()};d.onerror=function(){m("INSERT","Failed to insert data into '"+a+"': "+d.error.message)};var f=d.objectStore(a);if(Array===b.constructor){var e=0;l();var l=function(){e<b.length&&(f.put(b[e]).onsuccess=l);e++}}else f.put(b)}};
this.INSERTLIST=function(a,b,c){k.INSERT(a,b,c)};this.COUNT=function(a,b){if(k.IsAvailable()){var c=h.transaction([a],"readonly").objectStore(a).count();c.onsuccess=function(){"function"==typeof b&&b(c.result)};c.onerror=function(){m("SELECT","Failed to select '"+id+"': "+c.error.message)}}};this.SELECT=function(a,b,c){if(k.IsAvailable()){var d=[],f=h.transaction([a],"readonly");f.oncomplete=function(b){1<e.debug&&l("SELECT","Received "+d.length+" items from '"+a+"'");"function"==typeof c&&c(d)};
var f=f.objectStore(a),g;if(b)if(f.keyPath!=b.name){var n=b.value;b=f.index("ix"+b.name);g="object"===typeof n?b.openCursor(IDBKeyRange.bound(n[0],n[1])):null!=n?b.openCursor(IDBKeyRange.only(n)):b.openCursor()}else g=f.openCursor(IDBKeyRange.only(b.value));else b=IDBKeyRange.lowerBound(0),g=f.openCursor(b);g.onsuccess=function(a){a=a.target.result;!1!=!!a&&(d.push(a.value),a.continue())};g.onerror=function(){m("SELECT","Failed to select '"+id+"': "+g.error.message)}}};this.DELETE=function(a,b,c){if(k.IsAvailable()&&
void 0!=b){var d=h.transaction([a],"readwrite").objectStore(a),f;f="*"==b?d.clear():d.delete(b);f.onsuccess=function(d){0<e.debug&&l("DELETE","Item '"+b+"' deleted from "+a);"function"==typeof c&&c()};f.onerror=function(){m("DELETE","Failed to delete '"+b+"': "+f.error.message)}}};this.DELETEALL=function(a,b){k.DELETE(a,"*",b)};this.DESTROYALL=function(a){if(k.IsAvailable()){h&&h.close();var b=indexedDB.deleteDatabase(g);b.onsuccess=function(){0<e.debug&&l("DESTROYALL","Database '"+g+"' destroyed. Reload is recommended");
"function"==typeof a&&a()};b.onerror=function(){m("DESTROYALL","Failed to destroy '"+g+"': "+b.error.message)}}};(function(){if(k.IsAvailable())for(var a in p)e[a]=p[a]})()};
